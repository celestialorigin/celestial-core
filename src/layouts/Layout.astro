---
import "../styles/global.css";

const BASE = (import.meta.env.BASE_URL || "/").replace(/\/?$/, "/");
const { pathname } = Astro.url;
const { starPattern = "home", showStars = true, bodyClass = "" } = Astro.props;

// base配下でも「/」「/deep-observation」を正しく判定するため、論理パスを作る
// 二重スラッシュ事故を潰す
const logicalPath = pathname.startsWith(BASE)
  ? "/" + pathname.slice(BASE.length).replace(/^\/+/, "")
  : pathname;

let starsClass = "stars--mid";
if (logicalPath === "/" || logicalPath === "/index.html") {
  starsClass = "stars--high";
} else if (logicalPath.startsWith("/deep-observation")) {
  starsClass = "stars--low";
}
---
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href={`${BASE}favicon.svg`} />
    <meta name="generator" content={Astro.generator} />
    <slot name="head" />
    <title>CELESTIAL</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">

    <script>
      // Simple Intersection Observer for fade-in animations
      document.addEventListener('DOMContentLoaded', () => {
        const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };

        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              obs.unobserve(entry.target);
            }
          });
        }, observerOptions);

        document.querySelectorAll('.fade-in-section').forEach(section => {
          observer.observe(section);
        });
      });
    </script>
  </head>

<body
  class={bodyClass}
  data-star-pattern={starPattern}
  data-stars={showStars ? "on" : "off"}
  style={`--asset-base: ${BASE}; --lukia-sil: url('${BASE}images/lukia_front_raw.png'); --lucia-sil: url('${BASE}images/lucia_front_raw.png');`}
>

    <header class="site-header">
      <div class="header-inner">
        <a href={`${BASE}`} class="site-logo">
          <span class="site-logo-main">CELESTIAL</span>
          <span class="site-logo-sub">PROJECT</span>
        </a>

        <nav>
          <div class="nav-main">
            <a href={`${BASE}`}>Home</a>
            <!-- <a href={`${BASE}about/`}>About</a> REMOVED -->
            <a href={`${BASE}dialogues/`}>Dialogues</a>
            <a href={`${BASE}archive/`}>Archive</a>
			<a href={`${BASE}creations/`}>Creations</a>
            <a href={`${BASE}real-time/`}>Real-time</a>
            <a href={`${BASE}contact/`}>Contact</a>
          </div>

<!-- DEEP NAV REMOVED -->
        </nav>
      </div>
    </header>

    <main>
      <slot />
    </main>

    <footer class="site-footer">
      <!-- ✅ Shi-chan Resident (Deepest Level) -->
      <div class="footer-mascot-container">
        <a class="shiichan-footer-link" href={`${BASE}shiichan/`} aria-label="Shi-chan">
          <img src={`${BASE}images/しーちゃん_正面.png`} alt="" loading="lazy" />
        </a>
      </div>

      <div class="container footer-inner">
        <p>&copy; {new Date().getFullYear()} CELESTIAL. All systems nominal.</p>
<!-- DEEP FOOTER REMOVED -->
      </div>
    </footer>

    <div class:list={["stars", starsClass]} aria-hidden="true" style="pointer-events: none;"></div>

    <div id="home-secret-stars" class="secret-stars" aria-hidden="true">
      <a class="secret-star s1" href={`${BASE}tbd-01`} tabindex="-1" aria-label="green star"></a>
      <a class="secret-star s2" href={`${BASE}tbd-02`} tabindex="-1" aria-label="red star"></a>
      <a class="secret-star s3" href={`${BASE}tbd-03`} tabindex="-1" aria-label="blue star"></a>
      <a class="secret-star s4" href={`${BASE}tbd-04`} tabindex="-1" aria-label="brown star"></a>
      <a class="secret-star s5" href={`${BASE}tbd-05`} tabindex="-1" aria-label="silver star"></a>
      <a class="secret-star s6" href={`${BASE}tbd-06`} tabindex="-1" aria-label="yellow star"></a>
      <a class="secret-star s7" href={`${BASE}tbd-07`} tabindex="-1" aria-label="purple star"></a>
    </div>

    <!-- Sonic Trace Toast (global) -->
    <div id="sonic-trace-toast" class="sonic-trace-toast" aria-live="polite" aria-atomic="true">
      <div class="sonic-trace-head">
        <span class="sonic-trace-tag">SONIC_TRACE</span>
        <button id="sonic-trace-close" class="sonic-trace-close" aria-label="Close">×</button>
      </div>
      <div class="sonic-trace-body">
        <div id="sonic-trace-title" class="sonic-trace-title">NO SIGNAL</div>
        <div id="sonic-trace-text" class="sonic-trace-text">Awaiting input...</div>
      </div>
    </div>

    <!-- Observation Toast REMOVED -->

    <div class="scanlines" aria-hidden="true" style="pointer-events: none;"></div>
  </body>
</html>

<style is:global>
  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: var(--header-height);
    background: rgba(5, 5, 16, 0.8);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    z-index: 100;
    display: flex;
    align-items: center;
  }

  .header-inner {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 0 4%;
  }

  nav {
    display: flex;
    align-items: center;
    flex-grow: 1;
  }

  .nav-main {
    display: flex;
    gap: 2rem;
  }

  .site-logo {
    font-size: 0.9rem;
    line-height: 1;
    font-weight: 500;
    color: #fff;
    flex-shrink: 0;
    margin-right: 3rem;
    display: inline-flex;
    align-items: baseline;
    gap: 0.6em;
    text-decoration: none;
    letter-spacing: 0.05em;
    opacity: 0.95;
  }

  .site-logo-main {
    font-size: 1em;
    letter-spacing: 0.12em;
    font-weight: 500;
    opacity: 0.95;
  }

  .site-logo-sub {
    font-size: 1em;
    letter-spacing: 0.1em;
    font-weight: 500;
    opacity: 0.95;
    color: #fff;
  }

  @media (max-width: 480px) {
    .site-logo { gap: 0.5em; }
  }

  nav a {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: color 0.2s ease;
    text-decoration: none;
  }

  nav a:not(.nav-deep):hover { color: var(--c-accent); }

  main {
    min-height: 100vh;
    padding-top: var(--header-height);
  }

  .site-footer {
    padding: 2.5rem 0;
    color: rgba(255, 255, 255, 0.3);
    font-size: 0.8rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    margin-top: 4rem;
    position: relative;
  }

  /* Footer Mascot (Resident Entity) */
  .footer-mascot-container {
    text-align: center;
    margin-bottom: 80px; /* Space from footer bottom */
    position: relative;
    z-index: 5;
  }

  .shiichan-footer-link {
    display: inline-block;
    width: 110px;
    height: 110px;
    opacity: 0.85;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .shiichan-footer-link img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.1));
  }

  .shiichan-footer-link:hover {
    opacity: 1;
    transform: scale(1.05); /* Floating hover */
    filter: drop-shadow(0 0 25px rgba(0, 255, 255, 0.2));
  }

  .footer-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-deep, .footer-deep {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border: 1px solid rgba(138, 116, 178, 0.1);
    border-radius: 4px;
    background: rgba(40, 30, 60, 0.12);
    color: rgba(138, 116, 178, 0.45) !important;
    font-size: 0.75rem;
    text-decoration: none;
    letter-spacing: 0.1em;
    opacity: 0.75;
    transition: all 0.3s ease;
  }

  .nav-deep { margin-left: auto; }

  .nav-deep:hover, .footer-deep:hover {
    color: rgba(158, 136, 198, 0.8) !important;
    background: rgba(60, 45, 90, 0.2);
    border-color: rgba(138, 116, 178, 0.3);
    opacity: 0.9;
    box-shadow: 0 0 8px rgba(138, 116, 178, 0.05);
  }

  .icon-keyhole {
    width: 12px;
    height: 12px;
    fill: currentColor;
    opacity: 0.6;
  }

  @media (max-width: 768px) {
    .header-inner { flex-direction: column; gap: 1rem; }
    nav a { margin: 0 0.5rem; }
    .footer-inner { flex-direction: column; gap: 1.5rem; }
  }

  /* ===== Sonic Trace Toast ===== */
  .sonic-trace-toast {
    position: fixed !important;
    right: 28px !important;
    bottom: 28px !important;
    width: 360px;
    max-width: calc(100vw - 40px);
    background: rgba(5, 10, 18, 0.88) !important;
    border: 1px solid rgba(0, 255, 255, 0.22) !important;
    box-shadow: 0 0 18px rgba(0, 255, 255, 0.12) !important;
    backdrop-filter: blur(10px);
    border-radius: 10px;
    z-index: 9999 !important;

    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition: opacity .25s ease, transform .25s ease, visibility 0s linear .25s;
    visibility: hidden;
    display: none;

    color: rgba(255,255,255,0.95) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.95) !important;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace !important;
    text-shadow: 0 0 10px rgba(0,255,255,0.12);
  }

  .sonic-trace-toast.is-visible {
    opacity: 1 !important;
    transform: translateY(0) !important;
    pointer-events: auto !important;
    visibility: visible;
    display: block;
    transition-delay: 0s;
  }

  .sonic-trace-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.07);
  }

  .sonic-trace-tag {
    letter-spacing: .16em;
    font-size: 0.72rem;
    color: rgba(0, 255, 255, 0.9) !important;
    -webkit-text-fill-color: rgba(0, 255, 255, 0.9) !important;
  }

  .sonic-trace-close {
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.7) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.7) !important;
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
  }

  .sonic-trace-close:hover {
    color: rgba(255,255,255,0.98) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.98) !important;
  }

  .sonic-trace-body { padding: 12px; }

  .sonic-trace-title {
    font-size: 0.9rem;
    letter-spacing: .12em;
    margin-bottom: 6px;
    color: rgba(255,255,255,0.98) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.98) !important;
    opacity: 1 !important;
  }

  .sonic-trace-text {
    font-size: 0.78rem;
    line-height: 1.5;
    color: rgba(255,255,255,0.86) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.86) !important;
    opacity: 1 !important;
  }

  /* ===== Observation Toast ===== */
  .obs-toast {
    position: fixed !important;
    right: 28px !important;
    bottom: 28px !important;
    width: 360px;
    max-width: calc(100vw - 40px);
    background: rgba(12, 8, 18, 0.88) !important;
    border: 1px solid rgba(138, 116, 178, 0.30) !important;
    box-shadow: 0 0 18px rgba(138, 116, 178, 0.12) !important;
    backdrop-filter: blur(10px);
    border-radius: 10px;
    z-index: 9998 !important;

    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition: opacity .25s ease, transform .25s ease, visibility 0s linear .25s;
    visibility: hidden;
    display: none;

    color: rgba(255,255,255,0.95) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.95) !important;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace !important;
    text-shadow: 0 0 10px rgba(138,116,178,0.10);
  }

  .obs-toast.is-visible {
    opacity: 1 !important;
    transform: translateY(0) !important;
    pointer-events: auto !important;
    visibility: visible;
    display: block;
    transition-delay: 0s;
  }

  .obs-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.07);
  }

  .obs-tag {
    letter-spacing: .16em;
    font-size: 0.72rem;
    color: rgba(168, 146, 208, 0.95) !important;
    -webkit-text-fill-color: rgba(168, 146, 208, 0.95) !important;
  }

  .obs-close {
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.7) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.7) !important;
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
  }

  .obs-body { padding: 12px; }

  .obs-title, .obs-text {
    opacity: 1 !important;
    color: rgba(255,255,255,0.95) !important;
    -webkit-text-fill-color: rgba(255,255,255,0.95) !important;
  }

  .obs-title { font-size: 0.9rem; letter-spacing: .12em; margin-bottom: 6px; }
  .obs-text  { font-size: 0.78rem; line-height: 1.5; opacity: 0.88 !important; }
</style>
