---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const BASE = (import.meta.env.BASE_URL || "/").replace(/\/?$/, "/");
const now = new Date();
const toDate = (v: any) => (v instanceof Date ? v : new Date(v));

export async function getStaticPaths() {
  const entries = await getCollection("dialogues");
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;

// publishAt が Date / string どちらでも動くように
const publishAt = entry?.data?.publishAt ? toDate(entry.data.publishAt) : null;
const isFuture = !!(publishAt && publishAt > now);

const rendered = isFuture ? { Content: null } : await entry.render();
const Content = rendered.Content;

// SEO / OGP（未来ログは出さない）
const pageTitle = isFuture ? "CELESTIAL | UNOBSERVED" : `CELESTIAL | ${entry.data.title}`;
const pageDesc =
  !isFuture && entry.data.description ? String(entry.data.description) : null;

// canonical は BASE_URL 配下でも崩れないように BASE を使う
const canonicalUrl = !isFuture
  ? new URL(`${BASE}dialogues/${entry.slug}/`, Astro.site ?? "http://localhost").toString()
  : null;
---

<Layout showStars={true} starPattern="home" bodyClass="page-dialogue-single">
  <Fragment slot="head">
    <title>{pageTitle}</title>

    {isFuture ? (
      <meta name="robots" content="noindex, nofollow" />
    ) : (
      <>
        {pageDesc && <meta name="description" content={pageDesc} />}
        {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

        {/* OGP（未来ログは出さない） */}
        <meta property="og:type" content="article" />
        <meta property="og:title" content={pageTitle} />
        {pageDesc && <meta property="og:description" content={pageDesc} />}
        {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
      </>
    )}
  </Fragment>

  <article class="container page fade-in-section">
    <a href={`${BASE}dialogues/`}>← DIALOGUES</a>

    {isFuture ? (
      <section class="content">
        <h1 style="opacity:0.85;">UNOBSERVED</h1>
        <p style="opacity:0.7; margin-top:0.75rem;">
          このログは、まだ観測可能ではありません。
        </p>
        {publishAt && (
          <p style="opacity:0.4; font-size:0.9rem; margin-top:1.25rem;">
            Scheduled: {publishAt.toLocaleString("ja-JP")}
          </p>
        )}
      </section>
    ) : (
      <>
        <h1>{entry.data.title}</h1>
        {publishAt && (
          <p style="opacity:0.7;">
            {publishAt.toLocaleString("ja-JP")}
          </p>
        )}

        <section class="content">
          {Content ? <Content /> : null}
        </section>
      </>
    )}
  </article>
</Layout>
